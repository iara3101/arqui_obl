{
  "info": {
    "name": "CRM SaaS – API (Backend Local)",
    "_postman_id": "b2b9b2d6-0000-4000-8000-20250920-162049",
    "description": "Colección Postman para el backend local del CRM SaaS (NestJS + Fastify + Prisma). Incluye auth, privados, públicos, health y metrics.\nVariables: {{baseUrl}}, {{company_id}}, {{access_token}}, {{api_key}}.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Auth",
      "item": [
        {
          "name": "Login (JWT)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "auth",
                "login"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"admin@ort.test\",\n  \"password\": \"Admin123!\",\n  \"companyId\": \"{{company_id}}\"\n}"
            },
            "description": "Autentica y devuelve { access_token, forcePasswordReset }"
          },
          "response": [],
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('status 200', function(){ pm.response.to.have.status(200); });",
                  "const json = pm.response.json();",
                  "pm.environment.set('access_token', json.access_token);",
                  "if (json.companyId) pm.environment.set('company_id', json.companyId);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Health & Metrics",
      "item": [
        {
          "name": "Health",
          "request": {
            "method": "GET",
            "url": {
              "raw": "{{baseUrl}}/health",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "health"
              ]
            }
          }
        },
        {
          "name": "Metrics (Prometheus)",
          "request": {
            "method": "GET",
            "url": {
              "raw": "{{baseUrl}}/metrics",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "metrics"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Companies",
      "item": [
        {
          "name": "Create Company (ADMIN)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/companies",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "companies"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"ORT\"\n}"
            }
          }
        }
      ]
    },
    {
      "name": "Users & Invitations",
      "item": [
        {
          "name": "Send Invitation (ADMIN)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/users/invitations",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "users",
                "invitations"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"member@ort.test\"\n}"
            }
          },
          "response": []
        },
        {
          "name": "Accept Invitation",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/users/accept-invitation",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "users",
                "accept-invitation"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"token\": \"<paste-from-mailpit>\",\n  \"password\": \"Member123!\"\n}"
            }
          }
        },
        {
          "name": "Change Password (first login)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/users/change-password",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "users",
                "change-password"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"oldPassword\": \"Admin123!\",\n  \"newPassword\": \"AdminNew123!\"\n}"
            }
          }
        }
      ]
    },
    {
      "name": "API Keys (ADMIN)",
      "item": [
        {
          "name": "Create API Key",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/apikeys",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "apikeys"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"backend-reporting\"\n}"
            },
            "description": "Devuelve el valor **una sola vez**; guarda hash/jti."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "if (pm.response.code===201){ const v = pm.response.json().value; if(v) pm.environment.set('api_key', v);}"
                ]
              }
            }
          ]
        },
        {
          "name": "List API Keys (masked)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/apikeys",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "apikeys"
              ]
            }
          }
        },
        {
          "name": "Revoke API Key",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/apikeys/{{api_key_id}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "apikeys",
                "{{api_key_id}}"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Accounts",
      "item": [
        {
          "name": "Create Account",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/accounts",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "accounts"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Acme Corp\"\n}"
            }
          }
        },
        {
          "name": "List Accounts (paged)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/accounts?page=1&size=20",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "accounts"
              ],
              "query": [
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "size",
                  "value": "20"
                }
              ]
            }
          }
        },
        {
          "name": "Update Account",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/accounts/{{account_id}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "accounts",
                "{{account_id}}"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Acme Intl\"\n}"
            }
          }
        },
        {
          "name": "Delete Account",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/accounts/{{account_id}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "accounts",
                "{{account_id}}"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "Opportunities",
      "item": [
        {
          "name": "Create Opportunity",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/opportunities",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "opportunities"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"accountId\": \"{{account_id}}\",\n  \"title\": \"New deal\",\n  \"amount\": 1200,\n  \"stage\": \"Preparaci\\u00f3n\"\n}"
            }
          }
        },
        {
          "name": "List Opportunities (filters)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/opportunities?stage=Negociación&page=1&size=20",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "opportunities"
              ],
              "query": [
                {
                  "key": "stage",
                  "value": "Negociación"
                },
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "size",
                  "value": "20"
                }
              ]
            }
          }
        },
        {
          "name": "Change Stage",
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/opportunities/{{opportunity_id}}/stage",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "opportunities",
                "{{opportunity_id}}",
                "stage"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"newStage\": \"Venta\",\n  \"reason\": \"Closed won\"\n}"
            }
          }
        }
      ]
    },
    {
      "name": "Attachments",
      "item": [
        {
          "name": "Presign Upload",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/attachments/presign",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "attachments",
                "presign"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"opportunityId\": \"{{opportunity_id}}\",\n  \"filename\": \"quote.pdf\",\n  \"contentType\": \"application/pdf\"\n}"
            }
          },
          "description": "Devuelve URL/fields para subir a MinIO/S3."
        },
        {
          "name": "Confirm Upload",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{access_token}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/attachments/confirm",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "attachments",
                "confirm"
              ]
            },
            "body": {
              "mode": "raw",
              "raw": "{\n  \"opportunityId\": \"{{opportunity_id}}\",\n  \"filename\": \"quote.pdf\",\n  \"contentType\": \"application/pdf\",\n  \"size\": 12345\n}"
            }
          }
        }
      ]
    },
    {
      "name": "Reports (Public)",
      "item": [
        {
          "name": "Top Accounts (by sales)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "x-api-key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/reports/top-accounts?limit=3",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "reports",
                "top-accounts"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "3"
                }
              ]
            }
          }
        },
        {
          "name": "Stage Changes (by range & stage)",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "x-api-key",
                "value": "{{api_key}}"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/reports/stage-changes?stage=Negociación&from=2025-01-01&to=2025-12-31",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "reports",
                "stage-changes"
              ],
              "query": [
                {
                  "key": "stage",
                  "value": "Negociación"
                },
                {
                  "key": "from",
                  "value": "2025-01-01"
                },
                {
                  "key": "to",
                  "value": "2025-12-31"
                }
              ]
            }
          }
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000"
    },
    {
      "key": "company_id",
      "value": ""
    },
    {
      "key": "access_token",
      "value": ""
    },
    {
      "key": "api_key",
      "value": ""
    },
    {
      "key": "account_id",
      "value": ""
    },
    {
      "key": "opportunity_id",
      "value": ""
    },
    {
      "key": "api_key_id",
      "value": ""
    }
  ]
}